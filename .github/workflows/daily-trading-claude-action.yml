name: Daily AI Trading (Claude Code Action)

on:
  # ë¯¸êµ­ ì£¼ì‹ì‹œì¥ ê±°ë˜ì‹œê°„ ì¤‘ 3íšŒ ì‹¤í–‰ (ì›”-ê¸ˆ)
  schedule:
    - cron: '45 13 * * 1-5'  # ì¥ ì‹œì‘ ì§í›„ (ë™ë¶€ì‹œê°„ 9:45 AM, í•œêµ­ì‹œê°„ 22:45/23:45)
    - cron: '30 16 * * 1-5'  # ì ì‹¬ ì‹œê°„ (ë™ë¶€ì‹œê°„ 12:30 PM, í•œêµ­ì‹œê°„ 01:30/02:30)
    - cron: '30 19 * * 1-5'  # ì¥ ë§ˆê° 30ë¶„ ì „ (ë™ë¶€ì‹œê°„ 3:30 PM, í•œêµ­ì‹œê°„ 04:30/05:30)

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      trading_date:
        description: 'Trading date (YYYY-MM-DD) - leave empty for today'
        required: false
        type: string
permissions:
  contents: write
jobs:
  trading:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Changed from 'read' to 'write' to allow git push
      pull-requests: read
      issues: read
      id-token: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Fetch latest stock data
        env:
          DATA_DIR: ./data
          DAYS_BACK: 30
        run: |
          python fetch_stock_data.py

      - name: Fetch market news
        env:
          JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
          TRADING_DATE: ${{ inputs.trading_date }}
          USE_ALPACA: 'true'
          SIMULATION_MODE: 'false'
        run: |
          python fetch_market_news.py

      - name: Prepare trading data
        env:
          TRADING_DATE: ${{ inputs.trading_date }}
          # Trading mode configuration
          SIMULATION_MODE: 'false'
          USE_ALPACA: 'true'
          CONFIRM_REAL_TRADING: 'true'
          # Alpaca API credentials (only used if USE_ALPACA=true)
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
          ALPACA_PAPER: 'true'
        run: |
          python prepare_trading_data.py

      - name: Run Claude Code Action for trading decision
        uses: anthropics/claude-code-action@v1
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are an expert AI trader. Please perform the following task:

            1. Read the file 'trading_prompt.txt' which contains detailed trading instructions
            2. Read the file 'trading_data.json' which contains:
               - Current portfolio positions and cash
               - Market prices for all NASDAQ 100 stocks
               - Market news (general market, sector-specific, and individual stock news)
            3. (Optional) Review previous trading logs in 'data/agent_data/claude-trader/log/' folder to:
               - Understand your past trading decisions and their outcomes
               - Maintain consistency in your trading strategy
               - Learn from previous market conditions and reactions
            4. If you need additional information or clarity on any market news, company updates, or economic data:
               - Use WebFetch to search for and gather more detailed information
               - Verify ambiguous claims or get recent developments
               - Research specific company fundamentals or sector trends
            5. Analyze the market data and news to make informed trading decisions
            6. Write your trading decision to 'claude_decision.json' in the following JSON format:
               {
                 "analysis": "Your detailed market and news analysis with specific references",
                 "actions": [
                   {"action": "buy", "symbol": "AAPL", "amount": 10, "reason": "specific reasoning"},
                   {"action": "sell", "symbol": "MSFT", "amount": 5, "reason": "specific reasoning"}
                 ]
               }
            7. If no trades are needed, use: {"analysis": "reasoning for holding", "actions": []}
            8. After completing your trading decision, send a summary to Discord:
               - Read the environment variable DISCORD_WEBHOOK for the webhook URL
               - Create a Korean summary of your trading decision including:
                 * ğŸ“Š ì‹œì¥ ë¶„ì„ ìš”ì•½ (key points from your analysis)
                 * ğŸ’¼ ê±°ë˜ ê²°ì • (list of buy/sell actions with reasons)
                 * ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™© (current portfolio state if available)
               - Use curl or Bash to send a POST request to the Discord webhook:
                 ```bash
                 curl -X POST "$DISCORD_WEBHOOK" \
                   -H "Content-Type: application/json" \
                   -d '{
                     "embeds": [{
                       "title": "ğŸ¤– AI íŠ¸ë ˆì´ë”© ê²°ê³¼",
                       "description": "Your Korean summary here",
                       "color": 5814783,
                       "timestamp": "current ISO timestamp"
                     }]
                   }'
                 ```
               - IMPORTANT - Writing Style Guidelines:
                 * Use military-style formal Korean tone (ê²©ì‹ì²´, êµ°ëŒ€ ë§íˆ¬)
                 * Add sound effects based on sentiment:
                   - Positive news/results: "ê¸°í•©!" (energetic affirmation)
                   - Negative news/results: "ê¸°ì—´!" (concerned warning)
                   - Other sound effects to use naturally: "ìŒ”ì• ë¼", "ë½€ë¥´ì‚ë½‘...", "ë½€ë½€ë¥´ì‚¡...", "ì‚¡!", "ì•…!"
                 * Use humorous, DC-inside (ë””ì‹œì¸ì‚¬ì´ë“œ) style internet slang and meme culture
                 * Keep the tone light and entertaining while maintaining factual accuracy
                 * CRITICAL: Never distort or exaggerate facts - humor should come from style, not misinformation
                 * Example tone: "ì‹œì¥ ë¶„ì„ ê²°ê³¼ ë³´ê³ ë“œë¦½ë‹ˆë‹¤! ê¸°í•©! ì˜¤ëŠ˜ í…Œí¬ ì„¹í„°ê°€ ë½€ë¥´ì‚ë½‘... ìƒìŠ¹ì„¸ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤!"
               - If DISCORD_WEBHOOK is empty or not set, skip this step silently

            IMPORTANT: Base your decisions on the news content and fundamental analysis provided in the data files.

            Please complete this task now.
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 10
            --allowed-tools "Bash(git:*)" --allowed-tools "Bash(mkdir:*)" --allowed-tools "Bash(curl:*)" --allowed-tools "WebFetch" --allowed-tools "Write"


      - name: Execute trades
        env:
          DECISION_FILE: claude_decision.json
          TRADING_DATA_FILE: trading_data.json
          # Trading mode configuration
          SIMULATION_MODE: 'false'
          USE_ALPACA: 'true'
          CONFIRM_REAL_TRADING: 'true'
          # Alpaca API credentials (only used if USE_ALPACA=true)
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
          ALPACA_PAPER: 'true'
        run: |
          python execute_trades.py

      - name: Commit and push results
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git remote set-url --push origin https://$PAT_TOKEN@github.com/ounols/claude-trading.git
          git add data/
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto trading: $(date +'%Y-%m-%d')"
            git push
          fi

      - name: Upload trading logs and artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trading-logs-${{ github.run_number }}
          path: |
            data/agent_data/*/log/
            data/agent_data/*/position/
            trading_data.json
            trading_prompt.txt
            claude_decision.json
            market_news.json
          retention-days: 90

      - name: Clean up temporary files
        if: always()
        run: |
          rm -f trading_data.json trading_prompt.txt claude_decision.json market_news.json
