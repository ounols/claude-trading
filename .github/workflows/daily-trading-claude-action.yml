name: Daily AI Trading (Claude Code Action)

on:
  # ë§¤ì¼ í‰ì¼ UTC 22:30 ì‹¤í–‰ (ë¯¸êµ­ ë™ë¶€ì‹œê°„ ì˜¤í›„ 5:30 ë˜ëŠ” 6:30)
  schedule:
    - cron: '30 22 * * 1-5'  # ì›”-ê¸ˆ (í‰ì¼ë§Œ)

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      trading_date:
        description: 'Trading date (YYYY-MM-DD) - leave empty for today'
        required: false
        type: string

jobs:
  trading:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install yfinance python-dotenv requests

      - name: Fetch latest stock data
        env:
          DATA_DIR: ./data
          DAYS_BACK: 30
        run: |
          python fetch_stock_data.py

      - name: Fetch market news
        env:
          JINA_API_KEY: ${{ secrets.JINA_API_KEY }}
          TRADING_DATE: ${{ inputs.trading_date }}
        run: |
          python fetch_market_news.py

      - name: Prepare trading data
        env:
          TRADING_DATE: ${{ inputs.trading_date }}
        run: |
          python prepare_trading_data.py

      - name: Run Claude Code Action for trading decision
        uses: anthropics/claude-code-action@v1
        with:
          # trading_prompt.txtì— ì‘ì„±ëœ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
          prompt-file: 'trading_prompt.txt'
          # trading_data.json ë°ì´í„° íŒŒì¼ í¬í•¨
          context-files: |
            trading_data.json
          # Claudeì˜ ì‘ë‹µì„ claude_decision.jsonìœ¼ë¡œ ì €ì¥
          output-file: 'claude_decision.json'
          # ì‚¬ìš©í•  ëª¨ë¸
          model: 'claude-3-5-sonnet-20241022'
          # ìµœëŒ€ í† í°
          max-tokens: 2048

      - name: Execute trades
        env:
          DECISION_FILE: claude_decision.json
          TRADING_DATA_FILE: trading_data.json
        run: |
          python execute_trades.py

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add data/

          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto trading: $(date +'%Y-%m-%d')"
            git push
          fi

      - name: Upload trading logs and artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trading-logs-${{ github.run_number }}
          path: |
            data/agent_data/*/log/
            data/agent_data/*/position/
            trading_data.json
            trading_prompt.txt
            claude_decision.json
            market_news.json
          retention-days: 90

      - name: Clean up temporary files
        if: always()
        run: |
          rm -f trading_data.json trading_prompt.txt claude_decision.json market_news.json
